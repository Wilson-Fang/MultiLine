<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>MultiLine</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.ico">
    <link href="jquery-ui.css" rel="stylesheet" />
    <link href="css/bootstrap.css" rel="stylesheet" />
    <link href="css/sticky-footer.css" rel="stylesheet" />
    <script src="js/jquery.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/Common.js"></script>
    <style type="text/css">
        * {
            margin: 0;
        }

        /*html, body {
                height: 100%;
            }

            body {
                overflow: hidden;
            }*/

        /*.wrapper {
                min-height: 100%;
                height: auto !important;
                height: 100%;
                margin: 0 auto -20px;
            }*/

        .bubbleMe {
            position: relative;
            display: inline-block;
            max-width: 100%;
            min-height: 1.5em;
            padding: 15px;
            margin: 5px;
            background: #BEF18C;
            border: #BEF18C solid 4px;
            -webkit-border-radius: 20px;
            -moz-border-radius: 20px;
            border-radius: 20px;
        }

        .bubbleYou {
            position: relative;
            display: inline-block;
            max-width: 100%;
            min-height: 1.5em;
            padding: 15px;
            margin: 5px;
            background: #E4E8EB;
            border: #E4E8EB solid 4px;
            -webkit-border-radius: 20px;
            -moz-border-radius: 20px;
            border-radius: 20px;
        }

        .bubble:after {
            /*content: "";
                position: absolute;
                bottom: -15px;
                left: 60%;
                border-style: solid;
                border-width: 15px 15px 0;
                border-color: #FFFFFF transparent;
                display: block;
                width: 0;
                z-index: 1;*/
        }

        .bubble:before {
            /*content: "";
                position: absolute;
                bottom: -19.5px;
                left: calc(60% - 3px);
                border-style: solid;
                border-width: 18px 18px 0;
                border-color: #7F7F7F transparent;
                display: block;
                width: 0;
                z-index: 0;*/
        }

        .circularWilson {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            -webkit-border-radius: 50%;
            -moz-border-radius: 50%;
            background: url('images/wilson.png') no-repeat;
            display: inline-block;
        }

            .circularWilson img {
                opacity: 0;
                filter: alpha(opacity=0);
            }

        .circularSinging {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            -webkit-border-radius: 50%;
            -moz-border-radius: 50%;
            background: url('images/singing.png') no-repeat;
            display: inline-block;
        }

            .circularSinging img {
                opacity: 0;
                filter: alpha(opacity=0);
            }
    </style>
    <script type="text/javascript">
        var window_focus;
        var maxTime = "";
        var isFirst = true;
        var isNewMsg = false;
        var queryString = window.top.location.search.substring(1);

        $(document).ready(function () {
            $(window).focus(function () {
                window_focus = true;
                document.title = 'MultiLine';
            }).blur(function () {
                window_focus = false;
            });
            $(window).resize(function () {
                $("#chat").height($(window).height() - 250);
                $("#talk").width($(window).width() - 20);
            });
            $(window).trigger("resize");
            $("#chat").html("");
            $("#talk").width($(window).width() - 20);
            reload();
            setInterval(reload, 10000);
        });

        function reload() {
            getTalk();
        }

        function getTalk() {
            var time = [];
            var talk = [];
            var linkValue = "";
            var linkText = "";
            $.getJSON('https://spreadsheets.google.com/feeds/list/1oETHv5eEUgqJLYEjJmCjDirNsqPV21UWrfuErtyFvTo/1/public/values?alt=json', function (data) {
                var isUnread = false;
                for (var i = 0; i < data.feed.entry.length; i++) {
                    var isYouTube = false;
                    var googleDateTime = data.feed.entry[i].gsx$time.$t;
                    var googleDate = (googleDateTime.indexOf("上午") != -1) ? (googleDateTime.substr(0, googleDateTime.indexOf("上午"))) : (googleDateTime.substr(0, googleDateTime.indexOf("下午")));
                    var googleTime = (googleDateTime.indexOf("上午") != -1) ? (googleDateTime.substr(googleDateTime.indexOf("上午") + 3, googleDateTime.length - googleDateTime.indexOf("上午") - 3)) : (googleDateTime.substr(googleDateTime.indexOf("下午") + 3, googleDateTime.length - googleDateTime.indexOf("下午") - 3));
                    var googleYear = googleDate.substr(0, 4);
                    var googleMonth = googleDate.substr(googleDate.indexOf("/") + 1, googleDate.lastIndexOf("/") - googleDate.indexOf("/") - 1);
                    var googleDay = googleDate.substr(googleDate.lastIndexOf("/") + 1, googleDate.length - googleDate.lastIndexOf("/"));
                    var googleHour = googleTime.substr(0, googleTime.indexOf(":"));
                    var googleMinute = googleTime.substr(googleTime.indexOf(":") + 1, googleTime.lastIndexOf(":") - googleTime.indexOf(":") - 1);
                    var googleSecond = googleTime.substr(googleTime.lastIndexOf(":") + 1, googleTime.length - googleTime.lastIndexOf(":"));
                    if (googleDateTime.indexOf("上午") != -1) {
                        if (googleHour == "12") {
                            googleHour = (parseInt(googleHour) - 12).toString();
                        }
                    }
                    else {
                        if (parseInt(googleHour) < 12) {
                            googleHour = (parseInt(googleHour) + 12).toString();
                        }
                    }
                    if (parseInt(googleMonth) < 10) {
                        googleMonth = "0" + parseInt(googleMonth);
                    }
                    if (parseInt(googleDay) < 10) {
                        googleDay = "0" + parseInt(googleDay);
                    }
                    if (parseInt(googleHour) < 10) {
                        googleHour = "0" + parseInt(googleHour);
                    }
                    if (parseInt(googleMinute) < 10) {
                        googleMinute = "0" + parseInt(googleMinute);
                    }
                    if (parseInt(googleSecond) < 10) {
                        googleSecond = "0" + parseInt(googleSecond);
                    }
                    time[i] = "";
                    talk[i] = data.feed.entry[i].gsx$talk.$t.replace(/\n/g, "<br />");
                    linkValue = talk[i];
                    linkText = talk[i];
                    if (linkValue.match(/https?:\/\/dropjar\.com\/#/g)) {
                        linkValue = "http://1.dropjar.com/" + linkValue.substr(20) + ".zip";
                    }
                    if (linkValue.match(/https?:\/\/.+\.youtube\.com\//g)) {
                        isYouTube = true;
                    }
                    if (linkText.length >= 30) {
                        linkText = linkText.substr(0, 30) + "...";
                    }
                    if (maxTime == "") {
                        maxTime = googleYear + "/" + googleMonth + "/" + googleDay + " " + googleHour + ":" + googleMinute + ":" + googleSecond;
                        var bubbleCSS = "";
                        if (getParameter(queryString, "name") == data.feed.entry[i].gsx$name.$t) {
                            bubbleCSS = "bubbleMe";
                        }
                        else {
                            bubbleCSS = "bubbleYou";
                        }
                        if (data.feed.entry[i].gsx$name.$t == "wilson") {
                            if (data.feed.entry[i].gsx$talk.$t.match(re_weburl)) {
                                if (isYouTube) {
                                    var youTubeID = linkValue.split('v=')[1];
                                    var ampersandPosition = youTubeID.indexOf('&');
                                    if (ampersandPosition != -1) {
                                        youTubeID = youTubeID.substring(0, ampersandPosition);
                                    }
                                    $("#chat").append("<div class='" + bubbleCSS + "'><div class='circularWilson'><img src='images/wilson.png' /></div><div><iframe width='400' height='200' src='https://www.youtube.com/embed/" + youTubeID + "' frameborder='0' allowfullscreen></iframe></div></div><br /><br />");
                                }
                                else {
                                    $("#chat").append("<div class='" + bubbleCSS + "'><div class='circularWilson'><img src='images/wilson.png' /></div>" + time[i] + "  <a href='" + linkValue + "' target='_blank'>" + linkText + "</a></div><br /><br />");
                                }
                            }
                            else {
                                $("#chat").append("<div class='" + bubbleCSS + "'><div class='circularWilson'><img src='images/wilson.png' /></div>" + time[i] + "  " + talk[i] + "</div><br /><br />");
                            }
                        }
                        else {
                            if (data.feed.entry[i].gsx$talk.$t.match(re_weburl)) {
                                if (isYouTube) {
                                    var youTubeID = linkValue.split('v=')[1];
                                    var ampersandPosition = youTubeID.indexOf('&');
                                    if (ampersandPosition != -1) {
                                        youTubeID = youTubeID.substring(0, ampersandPosition);
                                    }
                                    $("#chat").append("<div class='" + bubbleCSS + "'><div class='circularSinging'><img src='images/singing.png' /></div><div><div><iframe width='400' height='200' src='https://www.youtube.com/embed/" + youTubeID + "' frameborder='0' allowfullscreen></iframe></div></div></div><br /><br />");
                                }
                                else {
                                    $("#chat").append("<div class='" + bubbleCSS + "'><div class='circularSinging'><img src='images/singing.png' /></div>" + time[i] + "  <a href='" + linkValue + "' target='_blank'>" + linkText + "</a></div><br /><br />");
                                }
                            }
                            else {
                                $("#chat").append("<div class='" + bubbleCSS + "'><div class='circularSinging'><img src='images/singing.png' /></div>" + time[i] + "  " + talk[i] + "</div><br /><br />");
                            }
                        }
                    }
                    else {
                        if (maxTime < (googleYear + "/" + googleMonth + "/" + googleDay + " " + googleHour + ":" + googleMinute + ":" + googleSecond)) {
                            maxTime = googleYear + "/" + googleMonth + "/" + googleDay + " " + googleHour + ":" + googleMinute + ":" + googleSecond;
                            var bubbleCSS = "";
                            if (getParameter(queryString, "name") == data.feed.entry[i].gsx$name.$t) {
                                bubbleCSS = "bubbleMe";
                            }
                            else {
                                bubbleCSS = "bubbleYou";
                            }
                            if (data.feed.entry[i].gsx$name.$t == "wilson") {
                                if (data.feed.entry[i].gsx$talk.$t.match(re_weburl)) {
                                    if (isYouTube) {
                                        var youTubeID = linkValue.split('v=')[1];
                                        var ampersandPosition = youTubeID.indexOf('&');
                                        if (ampersandPosition != -1) {
                                            youTubeID = youTubeID.substring(0, ampersandPosition);
                                        }
                                        $("#chat").append("<div class='" + bubbleCSS + "'><div class='circularWilson'><img src='images/wilson.png' /></div><div><iframe width='400' height='200' src='https://www.youtube.com/embed/" + youTubeID + "' frameborder='0' allowfullscreen></iframe></div></div><br /><br />");
                                    }
                                    else {
                                        $("#chat").append("<div class='" + bubbleCSS + "'><div class='circularWilson'><img src='images/wilson.png' /></div>" + time[i] + "  <a href='" + linkValue + "' target='_blank'>" + linkText + "</a></div><br /><br />");
                                    }
                                }
                                else {
                                    $("#chat").append("<div class='" + bubbleCSS + "'><div class='circularWilson'><img src='images/wilson.png' /></div>" + time[i] + "  " + talk[i] + "</div><br /><br />");
                                }
                            }
                            else {
                                if (data.feed.entry[i].gsx$talk.$t.match(re_weburl)) {
                                    if (isYouTube) {
                                        var youTubeID = linkValue.split('v=')[1];
                                        var ampersandPosition = youTubeID.indexOf('&');
                                        if (ampersandPosition != -1) {
                                            youTubeID = youTubeID.substring(0, ampersandPosition);
                                        }
                                        $("#chat").append("<div class='" + bubbleCSS + "'><div class='circularSinging'><img src='images/singing.png' /></div><div><iframe width='400' height='200' src='https://www.youtube.com/embed/" + youTubeID + "' frameborder='0' allowfullscreen></iframe></div></div><br /><br />");
                                    }
                                    else {
                                        $("#chat").append("<div class='" + bubbleCSS + "'><div class='circularSinging'><img src='images/singing.png' /></div>" + time[i] + "  <a href='" + linkValue + "' target='_blank'>" + linkText + "</a></div><br /><br />");
                                    }
                                }
                                else {
                                    $("#chat").append("<div class='" + bubbleCSS + "'><div class='circularSinging'><img src='images/singing.png' /></div>" + time[i] + "  " + talk[i] + "</div><br /><br />");
                                }
                            }
                            isNewMsg = true;
                            isUnread = true;
                            var elem = document.getElementById("chat");
                            elem.scrollTop = elem.scrollHeight;
                        }
                    }
                }
                if (!isFirst) {
                    if (window_focus) {
                        isNewMsg = false;
                        document.title = 'MultiLine';
                        document.getElementById("msn").pause();
                    }
                    else {
                        if (isNewMsg) {
                            document.title = '(*)MultiLine';
                            if (isUnread) {
                                document.getElementById("msn").play();
                            }

                        }
                        else {
                            document.title = 'MultiLine';
                            document.getElementById("msn").pause();
                        }
                    }
                }
                else {
                    isFirst = false;
                    isNewMsg = false;
                    document.title = 'MultiLine';
                    document.getElementById("msn").pause();
                }
            });
        }

        function postTalk() {
            $.ajax({
                url: 'https://docs.google.com/forms/d/1UlIgWmkFwmtwpcSlO4I-CZdWLPokRbIqdHTXWY6OpHM/formResponse',
                type: "post",
                data:
                    {
                        "entry.50664138": $("#talk").val(),
                        "entry.60691464": getParameter(queryString, "name")
                    },
                success: function () { $("#talk").val(""); reload(); },
                error: function () { $("#talk").val(""); reload(); }
            });
        }

        function keyin() {
            var key = window.event.keyCode;
            if (key == 13 && !window.event.ctrlKey) {
                postTalk();
                return false;
            }
            else if ((key == 10 || key == 13) && window.event.ctrlKey) {
                $("#talk").val($("#talk").val() + "\n");
                return true;
            }
            else {
                return true;
            }
        }

        function getParameter(queryString, parameterName) {
            var parameterName = parameterName + "=";
            if (queryString.length > 0) {
                begin = queryString.indexOf(parameterName);
                if (begin != -1) {
                    begin += parameterName.length;
                    end = queryString.indexOf("&", begin);
                    if (end == -1) {
                        end = queryString.length
                    }
                    return unescape(queryString.substring(begin, end));
                }
                return "null";
            }
            else {
                return "";
            }
        }

        function showImgPicker(imgSrc) {
            if (typeof (imgSrc) != "undefined") {
                $.ajax({
                    url: 'https://docs.google.com/forms/d/1UlIgWmkFwmtwpcSlO4I-CZdWLPokRbIqdHTXWY6OpHM/formResponse',
                    type: "post",
                    data: {
                        "entry.50664138": "<img src='" + imgSrc + "' height='120'>",
                        "entry.60691464": getParameter(queryString, "name")
                    },
                    success: function () { $("#talk").val(""); reload(); },
                    error: function () { $("#talk").val(""); reload(); }
                });
            }
        }

        function showUpload() {
            window.open("http://dropjar.com/", "_blank", "location=no,status=yes,scrollbars=yes,toolbar=no,menubar=no,width=320,height=370");
        }
    </script>
</head>
<body style="overflow-y:hidden">
    <audio id="msn">
        <source src="sound/MSN.mp3" type="audio/mpeg" />
    </audio>
    <table style="width:100%">
        <tr>
            <td>
                <div id="chat" style="width: 100%;overflow-y: scroll; overflow-x: hidden;display: inline-block;"></div>
            </td>
        </tr>
        <tr style="background-color:#E3E3E3">
            <td>
                <img src="images/attach.png" style="margin:5px;cursor:pointer" onclick="showUpload();" alt="" title="傳送檔案" />
            </td>
        </tr>
        <tr style="background-color:#E3E3E3">
            <td align="center">
                <textarea rows="4" id="talk" style="" onkeypress=" keyin();"></textarea>
            </td>
        </tr>
    </table>
    <div style="height:124px;overflow-x: hidden; overflow-y: scroll;">
        <img src="images/Kanahei-1/73696@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-1/73698@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-1/73701@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-1/73702@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-1/73703@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-1/73706@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-1/73715@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-1/73721@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-1/73726@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-2/355987@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-2/355989@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-2/355993@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-2/355994@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-2/355997@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-2/355998@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-2/355999@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-2/356002@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-2/356003@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-2/356005@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-2/356009@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-2/356013@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-2/356015@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435738@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435739@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435740@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435741@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435742@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435743@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435745@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435746@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435747@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435749@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435752@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435757@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435758@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435760@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435768@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435770@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435771@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435773@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-3/1435776@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995160@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995161@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995163@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995164@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995165@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995168@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995169@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995170@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995171@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995174@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995175@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995176@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995177@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995179@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995180@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995181@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995182@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995183@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995184@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995185@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995186@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995187@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995188@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995189@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995190@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995191@2x.png" height="61" onclick="showImgPicker(this.src);" />
        <img src="images/Kanahei-4/5995193@2x.png" height="61" onclick="showImgPicker(this.src);" />
    </div>
</body>
</html>
